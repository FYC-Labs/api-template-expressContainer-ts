# Build environment
FROM node:22.21.1-alpine3.22 AS build

WORKDIR /usr/app

COPY package.json yarn.lock ./

RUN yarn install --frozen-lockfile

COPY . .

RUN yarn prisma generate
RUN yarn build

# Production environment
FROM node:22.21.1-alpine3.22 AS production

WORKDIR /usr/app

COPY --from=build /usr/app/package.json /usr/app/yarn.lock /usr/app/tsconfig.json ./
COPY --from=build /usr/app/dist ./dist

RUN yarn install --frozen-lockfile --production

CMD yarn prisma db push && yarn start
